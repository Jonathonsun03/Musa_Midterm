---
title: "Hedonic Home Price Prediction"
author: "Jonathon Sun, Johnathan Clementi"
date: "9/29/2021"
output: html_document
---

```{r setup, include=FALSE}
pacman::p_load(tidyverse, tidycensus, sf, kableExtra, tmap, viridis, esquisse, gridExtra, spdep, caret, ckanr, FNN, grid, gridExtra, ggcorplot, httr)

options(scipen = 999)
options(scipen =  "sf")


source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")
```

## Pulling Data

```{r midterm_data}
read.csv(".RData.csv")

```


### Census 2019
```{r tidycensus_2019, echo=FALSE}

#variables on frequency of Race
Variables <- load_variables(2019,
                            "acs5",
                            cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("RACE", concept)) %>%
  filter(!grepl("AGE", concept)) %>%
  slice(1:10)

#variable median age, men and women not by race
A <- load_variables(2019,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN", concept)) %>%
  slice(1:3)

#Median Household Income
B <- load_variables(2019,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN INCOME", concept)) %>%
  slice(1)

# Cost of living
C <- load_variables(2019,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("COST", concept)) %>%
  slice(1:19)

Variables <- bind_rows(Variables, A, B, C)

acsTractsCol.2019.sf <- get_acs(geography = "tract",
        year = 2019,
        variables = Variables$name, 
        state="Colorado",
        county= c("Boulder"),
        geometry=T,
        output = "wide") %>% 
  st_transform('ESRI:102728') %>%
  dplyr::select (GEOID, NAME, all_of(paste0(Variables$name,"E"))) %>%
  mutate(Year = 2019)

ggplot() +
  geom_sf(data = acsTractsCol.2019.sf)
```

Census 2018
```{r tidycensus_2018, echo=FALSE}

#variables on frequency of Race
Variables <- load_variables(2018,
                            "acs5",
                            cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("RACE", concept)) %>%
  filter(!grepl("AGE", concept)) %>%
  slice(1:10)

#variable median age, men and women not by race
A <- load_variables(2018,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN", concept)) %>%
  slice(1:3)

#Median Household Income
B <- load_variables(2018,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN INCOME", concept)) %>%
  slice(1)

# Cost of living
C <- load_variables(2018,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("COST", concept)) %>%
  slice(1:19)

Variables <- bind_rows(Variables, A, B, C)

acsTractsCol.2018.sf <- get_acs(geography = "tract",
        year = 2018,
        variables = Variables$name, 
        state="Colorado",
        county= c("Boulder"),
        geometry=T,
        output = "wide") %>% 
  st_transform('ESRI:102728') %>%
  dplyr::select (GEOID, NAME, all_of(paste0(Variables$name,"E"))) %>%
  mutate(Year = 2018)

ggplot() +
  geom_sf(data = acsTractsCol.2018.sf)
```

Website available for data https://open-data.bouldercolorado.gov/ 

```{r colorado_data}

# Locations of 19 libraries 
## https://opendata-bouldercounty.hub.arcgis.com/datasets/libraries-2/explore?location=40.001009%2C-105.302539%2C11.28

Col_Library <- st_read("https://opendata.arcgis.com/datasets/7f4ea25ba87345e380d2e896611d2588_0.geojson") %>%
  st_transform(st_crs(acsTractsCol.2019.sf)) %>%
  select(c(Name, geometry))

Buffer_Library <- st_buffer(Col_Library, 10560) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend)

UnionBuffer_Library <- st_union(Buffer_Library)

ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Col_Library) +
  geom_sf(data = UnionBuffer_Library,
          fill = "transparent") +
  labs(title = "library")

allTracts.rings <-
  st_join(st_centroid(dplyr::select(acsTractsCol.2019.sf, GEOID)), 
          multipleRingBuffer(Buffer_Library, 5280, 2640)) %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(acsTractsCol.2019.sf, GEOID), 
            by=c("GEOID"="GEOID")) %>%
  st_sf()

# Properties managed by parks and recreation polygons ## https://open-data.bouldercolorado.gov/datasets/fdfc0410e75c48b6b9e53cf94bdbe224_1/explore?location=40.026750%2C-105.234200%2C12.05 
Parks <- st_read("https://opendata.arcgis.com/datasets/fdfc0410e75c48b6b9e53cf94bdbe224_1.geojson")

# Grocery Stores from Data Axle
Grocery_Store <- read.csv("DataAxle_GroceryStores.csv") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102286') 

Buffer_Grocery <- st_union(st_buffer(Grocery_Store, 5280) %>%
      mutate(Legend = "Buffer") %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer") %>%
      dplyr::select(Legend))

ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Grocery_Store) +
    geom_sf(data = Buffer_Grocery,
          fill = "transparent") +
  labs(title = "Grocery_Stores")

allTracts.rings <-
  st_join(st_centroid(dplyr::select(acsTractsCol.2019.sf, GEOID, Year)), 
          multipleRingBuffer(Buffer_Grocery, 5280, 2640)) %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(acsTractsNJ.ALL.sf, GEOID), 
            by=c("GEOID"="GEOID")) %>%
  st_sf()

#Restaurants from DataAxle
Restaurants <- bind_rows(read.csv("DataAxle_Restaurants_1.csv"), read.csv("DataAxle_Restaurants_2.csv")) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102286')

Buffer_Restaurants <- st_union(st_buffer(Restaurants, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend))


ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Restaurants) +
    geom_sf(data = Buffer_Restaurants,
          fill = "transparent") +
  labs(title = "Restaurants")


#Education from DataAxle
Education <- read.csv("DataAxle_Education.csv") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102286')

Buffer_Education <- st_union(st_buffer(Education, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend))

ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Education) +
  geom_sf(data = Buffer_Education,
          fill = "transparent") +
  labs(title = "Schools")

#Museums from DataAxle
Museums <- read.csv("DataAxle_Musuems.csv") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102286')

Buffer_Museums <- st_union(st_buffer(Museums, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend))

ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "white") +
  geom_sf(data = Museums) +
  geom_sf(data = Buffer_Museums,
          fill = "transparent") +
  labs(title = "Museums")

```


```{r Centroid, message=FALSE, warning=FALSE}
# Creating centroids

#Rather than pick a half mile (2640 feet) I chose to use a 2 mile radius. Since I am working with suburbs, homes are further away from the regional lines. 

# Buffers for stations
Buffers <- 
  rbind(
    st_buffer(NJtransit, 10560) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend),
    st_union(st_buffer(NJtransit, 10560)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))




Linebuffer <- rbind(
    st_buffer(NjTransit_Lines, 10560) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend),
    st_union(st_buffer(NjTransit_Lines, 10560)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))


ggplot() +
  geom_sf(data=Buffers) +
  geom_sf(data = Linebuffer) +
  geom_sf(data=NJtransit, 
          aes(colour = STATION), 
          show.legend = "point", size= 2) +
  geom_sf(data = NjTransit_Lines) +
  facet_wrap(~Legend) + 
  mapTheme()


selectCentroids <-
  st_centroid(acsTractsNJ.2019.sf)[Buffers,] %>%
    st_drop_geometry() %>%
    left_join(dplyr::select(acsTractsNJ.2019.sf, GEOID)) %>%
    st_sf() %>%
  mutate(Select_type = "Select by Centroid")
```

# Appendix

Data I don't know what to do with. 

```{r}
#addresses for buildings https://open-data.bouldercolorado.gov/datasets/d63e537da54640bd967c2fedc4c99a92_0/explore?location=40.026211%2C-105.232810%2C11.82 
Addresses <- st_read("https://opendata.arcgis.com/datasets/d63e537da54640bd967c2fedc4c99a92_0.geojson") %>%
  st_transform('ESRI:102286')

ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Addresses) +
  labs(title = "Addresses")
```

