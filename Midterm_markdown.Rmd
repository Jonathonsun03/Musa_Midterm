---
title: "Hedonic Home Price Prediction"
author: "Jonathon Sun, Johnathan Clementi"
date: "9/29/2021"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(warning = FALSE)
pacman::p_load(tidyverse, tidycensus, sf, kableExtra, tmap, viridis, gridExtra, spdep, caret, ckanr, FNN, grid, gridExtra, ggcorplot, httr, sf)
library(ggcorrplot)

options(scipen = 999)
options(scipen =  "sf")

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")
```

## Pulling Data

```{r housedata, message=FALSE, warning=FALSE}
# Set CRS for project
CO_statePlaneCentral = "ESRI:102254"

studentData <- st_read("studentData.geojson", crs = CO_statePlaneCentral) %>%
  mutate(pricePerSF = price/TotalFinishedSF,
         age = 2021 - builtYear,
         iprvmntAge = EffectiveYear - builtYear) %>%
  # Change NA address values to something R won't get rid of when we do na.omit()
  mutate(address=replace_na(address,"No address given")) %>%
  # Remove numeric categorical vars - there are already descriptions for these values in the df
  dplyr::select(-Stories, -UnitCount, -Ac, -Heating, -ExtWallPrim, -ExtWallSec, -IntWall, -Roof_Cover, -status_cd) %>%
  st_transform(CO_statePlaneCentral) 


studentData.training <- studentData %>%
    filter(toPredict == 0)

studentData.challenge <- studentData %>%
    filter(toPredict == 1)

# Check to see we aren't loosing records
# testTrain <- studentData.training %>% na.omit()
# addition <- rbind(studentData.training,testTrain)
# difference <- addition[! duplicated(addition, fromLast = TRUE) & seq(nrow(addition)) <= nrow(studentData.training), ]
```


### Census 2019

Look for zip codes not census tracts, because who purchases by census tracts?


```{r tidycensus_2019, echo=FALSE}

#variables on frequency of Race
Variables <- load_variables(2019,
                            "acs5",
                            cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("RACE", concept)) %>%
  filter(!grepl("AGE", concept)) %>%
  slice(1:10)

#variable median age, men and women not by race
A <- load_variables(2019,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN", concept)) %>%
  slice(1:3)

#Median Household Income
B <- load_variables(2019,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN INCOME", concept)) %>%
  slice(1)

# Cost of living
C <- load_variables(2019,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("COST", concept)) %>%
  slice(1:19)

Variables <- bind_rows(Variables, A, B, C)

# Pull census data using tidycensus

# Read in census tracts

acsTractsCol.2019.sf <- get_acs(geography = "tract",
        year = 2019,
        variables = Variables$name, 
        state="Colorado",
        county= c("Boulder"),
        geometry=T,
        output = "wide") %>% 
  st_transform(CO_statePlaneCentral)%>%
  dplyr::select (GEOID, NAME, all_of(paste0(Variables$name,"E")))
```

```{r, schoolDistricts}
#Unified School District
acsSchoolDistrctssCol.2019.sf <- get_acs(geography = "school district (unified)",
        year = 2019,
        variables = Variables$name, 
        state="Colorado",
        geometry=T,
        output = "wide") %>% 
  st_transform(CO_statePlaneCentral) %>%
  dplyr::select (GEOID, NAME, all_of(paste0(Variables$name,"E")))

school_districts <- st_overlaps(st_union(acsTractsCol.2019.sf), acsSchoolDistrctssCol.2019.sf)
acsSchoolDistrctssCol.2019.sf <- acsSchoolDistrctssCol.2019.sf %>%
  slice(school_districts[[1]])

# Assign a school district to each home
# Help document: https://gis.stackexchange.com/questions/133625/checking-if-points-fall-within-polygon-shapefile
studentData.training <- studentData.training %>%
  mutate(
    District = paste0("District",as.integer(st_intersects(geometry,acsSchoolDistrctssCol.2019.sf)))
    #,
    #schoolDist_name = if_else(is.na(District), "", acsSchoolDistrctssCol.2019.sf$NAME[District])
  )


ggplot() +
  geom_sf(data = acsSchoolDistrctssCol.2019.sf,
          fill = "red") +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent")
```
```{r cityLimits}
boulderCityLimits <- st_read("https://opendata.arcgis.com/datasets/955e7a0f52474b60a9866950daf10acb_0.geojson") %>%
  st_transform(st_crs(acsTractsCol.2019.sf)) %>%
  mutate(inCity = 1)

# Determine if a house is within the city or not - used for cases in which only city data is available
studentData.training <- studentData.training %>%
  mutate(withinCity = as.integer(st_intersects(geometry,boulderCityLimits)))

studentData.training <- studentData.training %>%
  mutate(withinCity = replace_na(withinCity,"0"))

# Change 
studentData.training <- studentData.training %>%
  mutate(withinCity = ifelse(withinCity > 0, 1, 0))
```



```{r, zipCodes}
#Zip Code
acsZipsCol.2019.sf <- get_acs(geography = "zcta",
        year = 2019,
        variables = Variables$name, 
        geometry=T,
        output = "wide") %>% 
  st_transform(CO_statePlaneCentral) %>%
  dplyr::select (GEOID, NAME, all_of(paste0(Variables$name,"E")))

zipcodes <- st_overlaps(st_union(acsTractsCol.2019.sf), acsZipsCol.2019.sf)
acsZipsCol.2019.sf <- acsZipsCol.2019.sf %>%
  slice(zipcodes[[1]])

# Assign a zipcode to each home
# Help document: https://gis.stackexchange.com/questions/133625/checking-if-points-fall-within-polygon-shapefile
studentData.training <- studentData.training %>%
  mutate(
    Zip = paste0("Zip",as.integer(st_intersects(geometry,acsZipsCol.2019.sf)))
    #,
    #zipcode = if_else(is.na(Zip), "", acsSchoolDistrctssCol.2019.sf$NAME[Zip])
  )


# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(1),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Session = row_number(),
#                                    Zip1 = ifelse(Session %in% district[[1]], "Zip1", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(2),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip2 = ifelse(Session %in% district[[1]], "Zip2", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(3),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip3 = ifelse(Session %in% district[[1]], "Zip3", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(4),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip4 = ifelse(Session %in% district[[1]], "Zip4", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(5),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip5 = ifelse(Session %in% district[[1]], "Zip5", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(6),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip6 = ifelse(Session %in% district[[1]], "Zip6", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(7),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip7 = ifelse(Session %in% district[[1]], "Zi73", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(8),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip8 = ifelse(Session %in% district[[1]], "Zip8", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(9),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip9 = ifelse(Session %in% district[[1]], "Zip9", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(10),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip10 = ifelse(Session %in% district[[1]], "Zip10", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(11),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip11 = ifelse(Session %in% district[[1]], "Zip11", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(12),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip12 = ifelse(Session %in% district[[1]], "Zip12", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(13),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip13 = ifelse(Session %in% district[[1]], "Zip13", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(14),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip14 = ifelse(Session %in% district[[1]], "Zip14", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(15),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip15 = ifelse(Session %in% district[[1]], "Zip15", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(16),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip16 = ifelse(Session %in% district[[1]], "Zip16", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(17),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip17 = ifelse(Session %in% district[[1]], "Zip17", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(18),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip18 = ifelse(Session %in% district[[1]], "Zip18", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(19),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip19 = ifelse(Session %in% district[[1]], "Zip19", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(20),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip20 = ifelse(Session %in% district[[1]], "Zip20", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(21),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip21 = ifelse(Session %in% district[[1]], "Zip21", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(22),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                             mutate(Zip22 = ifelse(Session %in% district[[1]], "Zip22", "NO"))
# 
# district <- st_intersects(acsZipsCol.2019.sf %>%
#   slice(23),
#   studentData.training)
# 
# studentData.training <- studentData.training %>%
#                            mutate(Zip23 = ifelse(Session %in% district[[1]], "Zip23", "NO"))
# 
# A <- studentData.training %>%
#   select(50:73) %>%
#   pivot_longer(cols = 2:23, names_to = "Zip") %>%
#   filter(!value == "NO") %>%
#   select(1:3)
# 
# studentData.training <- st_join(studentData.training, A, by = "Session") %>%
#   select(-c("Zip1","Zip2","Zip3","Zip4","Zip5","Zip6","Zip7","Zip8","Zip9","Zip10",
#             "Zip11","Zip12","Zip13","Zip14","Zip15","Zip16","Zip17","Zip18","Zip19","Zip20",
#             "Zip21","Zip22","Zip23","Session.x"))

ggplot() +
  geom_sf(data = acsTractsCol.2019.sf) +
  labs(title = "Census Tracts, Boulder County, Colorado")

# # Read in census Block groups
# acsBGCol.2019.sf <- get_acs(geography = "block group",
#         year = 2019,
#         variables = Variables$name, 
#         state="Colorado",
#         county= c("Boulder"),
#         geometry=T,
#         output = "wide") %>% 
#   st_transform(CO_statePlaneCentral) %>%
#   dplyr::select (GEOID, NAME, all_of(paste0(Variables$name,"E")))
# 
# ggplot() +
#   geom_sf(data = acsBGCol.2019.sf)+
#   labs(title = "Census Block Groups, Boulder County, Colorado")


```

Census 2018

CURRENTLY NOT RUNNING
```{r tidycensus_2018, eval=FALSE, include=FALSE}

#variables on frequency of Race
Variables <- load_variables(2018,
                            "acs5",
                            cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("RACE", concept)) %>%
  filter(!grepl("AGE", concept)) %>%
  slice(1:10)

#variable median age, men and women not by race
A18 <- load_variables(2018,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN", concept)) %>%
  slice(1:3)

#Median Household Income
B18 <- load_variables(2018,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("MEDIAN INCOME", concept)) %>%
  slice(1)

# Cost of living
C18 <- load_variables(2018,
                    "acs5",
                    cache = TRUE) %>%
  mutate(Merge_name = paste(name,"E", sep ="")) %>%
  filter(grepl("COST", concept)) %>%
  slice(1:19)

Variables <- bind_rows(Variables, A18, B18, C18)

acsTractsCol.2018.sf <- get_acs(geography = "tract",
        year = 2018,
        variables = Variables$name, 
        state="Colorado",
        county= c("Boulder"),
        geometry=T,
        output = "wide") %>% 
  st_transform(CO_statePlaneCentral) %>%
  dplyr::select (GEOID, NAME, all_of(paste0(Variables$name,"E"))) %>%
  mutate(Year = 2018)

ggplot() +
  geom_sf(data = acsTractsCol.2018.sf)
```

# Fixed Effect Census tracts 

```{r}
Census_tracts <- unique(acsTractsCol.2019.sf$GEOID)
z <- st_intersection(studentData.training, acsTractsCol.2019.sf %>%
                  filter(GEOID == Census_tracts[1]))

```

Website available for data https://open-data.bouldercolorado.gov/ 

```{r colorado_data}

# # Locations of Rental Properties (by license)
# ## https://open-data.bouldercolorado.gov/datasets/92f70ea894ef47a582bb0d656aa4aa7d_0/explore?location=40.013774%2C-105.256817%2C16.81
# rentalHomes <- st_read("https://opendata.arcgis.com/datasets/92f70ea894ef47a582bb0d656aa4aa7d_0.geojson") %>%
#   st_transform(CO_statePlaneCentral)
# 
# ggplot() +
#   geom_sf(data = st_union(acsTractsCol.2019.sf),
#           fill = "transparent") +
#   geom_sf(data = st_centroid(rentalHomes)) +
#   labs(title = "Rental Homes")
# 
# 
# # Locations of Accessory Dwelling Units
# ## https://open-data.bouldercolorado.gov/datasets/669935e6d13c406497cd9cbbbd7951b2_0/explore?location=40.023716%2C-105.253583%2C11.91
# ## For explanation on what ADU's are: https://planning.org/knowledgebase/accessorydwellings/ 
# adus <- st_read("https://opendata.arcgis.com/datasets/669935e6d13c406497cd9cbbbd7951b2_0.geojson") %>%
#   st_transform(CO_statePlaneCentral)
# 
# ggplot() +
#   geom_sf(data = st_union(acsTractsCol.2019.sf),
#           fill = "transparent") +
#   geom_sf(data = adus) +
#   labs(title = "Accessory Dwelling Units")
# 
# 
# # Locations of 100 Year floodplain within Boulder County
# # Data originally for the whole state, subsetted to Boulder County via st_intersect
# ## https://geo.colorado.edu/catalog/47540-5ca228ffd43267000b8c7448
# ## About this dataset: https://open-data.bouldercolorado.gov/datasets/bfc343d63cf54831810b983b36ce6872_3/about
# 
# 
# # # Process for creating Boulder County Flood Plains shp
# # COState_flood <- st_read("CO_state_100yrFloodplains.geojson") %>%
# #   st_transform(CO_statePlaneCentral)
# # 
# # boulderCo_flood <- COState_flood %>%
# #   st_intersection(st_union(acsTractsCol.2019.sf)) %>%
# #   st_sf()
# # 
# # # Create Geopackage for ease of transport - only one file
# # st_write(boulderCo_flood, "boulderCo_100yrFloodZones.gpkg")
# 
# boulderCo_flood_shp <- st_read("boulderCo_100yrFloodZones.gpkg")
# 
# 
# ggplot() +
#   geom_sf(data = st_union(acsTractsCol.2019.sf),
#           fill = "transparent") +
#   geom_sf(data = boulderCo_flood_shp)
# 
# 
# # Locations of Zoning districts
# ## https://open-data.bouldercolorado.gov/datasets/e88004e26b9e42cfba32129fb8731f41_0/explore?location=40.025701%2C-105.239775%2C11.45
# ## City of Boulder Colorado Zoning Districts. Including residential, business, industrial, public, agricultural, mix of residential and business, residential mobile homes, main street area and mixed density residential.
# zoning <- st_read("https://opendata.arcgis.com/datasets/e88004e26b9e42cfba32129fb8731f41_0.geojson") %>%
#   st_transform(CO_statePlaneCentral)
# 
# ggplot() +
#   geom_sf(data = st_union(acsTractsCol.2019.sf),
#           fill = "transparent") +
#   geom_sf(data = zoning) +
#   labs(title = "Zoning Districts")


# Locations of 19 libraries 
## https://opendata-bouldercounty.hub.arcgis.com/datasets/libraries-2/explore?location=40.001009%2C-105.302539%2C11.28

Col_Library <- st_read("https://opendata.arcgis.com/datasets/7f4ea25ba87345e380d2e896611d2588_0.geojson") %>%
  st_transform(st_crs(acsTractsCol.2019.sf)) %>%
  select(c(Name, geometry))

Buffer_Library <- st_buffer(Col_Library, 10560) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend)

UnionBuffer_Library <- st_union(Buffer_Library)


ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Col_Library) +
  geom_sf(data = UnionBuffer_Library,
          fill = "transparent") +
  labs(title = "library")

allTracts.rings <-
  st_join(st_centroid(dplyr::select(acsTractsCol.2019.sf, GEOID)), 
          multipleRingBuffer(Buffer_Library, 5280, 2640)) %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(acsTractsCol.2019.sf, GEOID), 
            by=c("GEOID"="GEOID")) %>%
  st_sf()


#addresses for buildings https://open-data.bouldercolorado.gov/datasets/d63e537da54640bd967c2fedc4c99a92_0/explore?location=40.026211%2C-105.232810%2C11.82 
# Addresses <- st_read("https://opendata.arcgis.com/datasets/d63e537da54640bd967c2fedc4c99a92_0.geojson") %>%
#   st_transform(CO_statePlaneCentral)
# 
# ggplot() +
#   geom_sf(data = st_union(acsTractsCol.2019.sf),
#           fill = "transparent") +
#   geom_sf(data = Addresses) +
#   labs(title = "Addresses")

# Properties managed by parks and recreation polygons ## https://open-data.bouldercolorado.gov/datasets/fdfc0410e75c48b6b9e53cf94bdbe224_1/explore?location=40.026750%2C-105.234200%2C12.05 
Parks <- st_read("https://opendata.arcgis.com/datasets/fdfc0410e75c48b6b9e53cf94bdbe224_1.geojson")


# Urban trees
## https://open-data.bouldercolorado.gov/datasets/dbbae8bdb0a44d17934243b88e85ef2b_0/explore?location=40.015538%2C-105.275671%2C16.12
trees <- st_read("https://opendata.arcgis.com/datasets/dbbae8bdb0a44d17934243b88e85ef2b_0.geojson") %>%
    st_transform(CO_statePlaneCentral)

ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = trees) +
  labs(title = "Street Trees")


```

#Buffers

```{r}
# Grocery Stores from Data Axle
Grocery_Store <- read.csv("DataAxle_GroceryStores.csv") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform(CO_statePlaneCentral) 

Buffer_Grocery <- st_buffer(Grocery_Store, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend)

Buffer_Grocery_Union <- st_union(st_buffer(Grocery_Store, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend))

ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Grocery_Store) +
    geom_sf(data = Buffer_Grocery,
          fill = "transparent") +
  labs(title = "Grocery_Stores")

Grocery.rings <-
  st_join(st_centroid(dplyr::select(acsTractsCol.2019.sf, GEOID)), 
          multipleRingBuffer(Buffer_Grocery, 5280, 2640)) %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(acsTractsCol.2019.sf, GEOID), 
            by=c("GEOID"="GEOID")) %>%
  st_sf()


#Restaurants from DataAxle
Restaurants <- bind_rows(read.csv("DataAxle_Restaurants_1.csv"), read.csv("DataAxle_Restaurants_2.csv")) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform(CO_statePlaneCentral)

Buffer_Restaurants <- st_union(st_buffer(Restaurants, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend))


ggplot() +
  geom_sf(data = st_union(acsTractsCol.2019.sf),
          fill = "transparent") +
  geom_sf(data = Restaurants) +
    geom_sf(data = Buffer_Restaurants,
          fill = "transparent") +
  labs(title = "Restaurants")

#Education from DataAxle
Education <- read.csv("DataAxle_Education.csv") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform(CO_statePlaneCentral)

Buffer_Education <- st_union(st_buffer(Education, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend))


#Museums from DataAxle
Museums <- read.csv("DataAxle_Musuems.csv") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform(CO_statePlaneCentral)

Buffer_Museums <- st_union(st_buffer(Museums, 5280) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend))


```


#Nearest Neighbors

```{r}
## grovery Nearest Neighbor
st_c <- st_coordinates

## restaurante NN
studentData.training <- studentData.training %>%
  mutate(grocery_nn1 = nn_function(st_c(studentData.training), st_c(Grocery_Store), 1),
         grocery_nn2 = nn_function(st_c(studentData.training), st_c(Grocery_Store), 2),
         grocery_nn3 = nn_function(st_c(studentData.training), st_c(Grocery_Store), 3),
         grocery_nn4 = nn_function(st_c(studentData.training), st_c(Grocery_Store), 4),
         grocery_nn5 = nn_function(st_c(studentData.training), st_c(Grocery_Store), 5))

studentData.training <- studentData.training %>%
  mutate(restaurant_nn1 = nn_function(st_c(studentData.training), st_c(Restaurants), 1),
         restaurant_nn2 = nn_function(st_c(studentData.training), st_c(Restaurants), 2),
         restaurant_nn3 = nn_function(st_c(studentData.training), st_c(Restaurants), 3),
         restaurant_nn4 = nn_function(st_c(studentData.training), st_c(Restaurants), 4),
         restaurant_nn5 = nn_function(st_c(studentData.training), st_c(Restaurants), 5))

studentData.training <- studentData.training %>%
  mutate(Education_nn1 = nn_function(st_c(studentData.training), st_c(Education), 1),
         Education_nn2 = nn_function(st_c(studentData.training), st_c(Education), 2),
         Education_nn3 = nn_function(st_c(studentData.training), st_c(Education), 3),
         Education_nn4 = nn_function(st_c(studentData.training), st_c(Education), 4),
         Education_nn5 = nn_function(st_c(studentData.training), st_c(Education), 5))

studentData.training <- studentData.training %>%
  mutate(Museums_nn1 = nn_function(st_c(studentData.training), st_c(Museums), 1),
         Museums_nn2 = nn_function(st_c(studentData.training), st_c(Museums), 2),
         Museums_nn3 = nn_function(st_c(studentData.training), st_c(Museums), 3),
         Museums_nn4 = nn_function(st_c(studentData.training), st_c(Museums), 4),
         Museums_nn5 = nn_function(st_c(studentData.training), st_c(Museums), 5))
```

```{r Centroid, message=FALSE, warning=FALSE}
# Creating centroids

#Rather than pick a half mile (2640 feet) I chose to use a 2 mile radius. Since I am working with suburbs, homes are further away from the regional lines. 

# Buffers for stations
Buffers <- 
  rbind(
    st_buffer(NJtransit, 10560) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend),
    st_union(st_buffer(NJtransit, 10560)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))




Linebuffer <- rbind(
    st_buffer(NjTransit_Lines, 10560) %>%
      mutate(Legend = "Buffer") %>%
      dplyr::select(Legend),
    st_union(st_buffer(NjTransit_Lines, 10560)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))


ggplot() +
  geom_sf(data=Buffers) +
  geom_sf(data = Linebuffer) +
  geom_sf(data=NJtransit, 
          aes(colour = STATION), 
          show.legend = "point", size= 2) +
  geom_sf(data = NjTransit_Lines) +
  facet_wrap(~Legend) + 
  mapTheme()


selectCentroids <-
  st_centroid(acsTractsNJ.2019.sf)[Buffers,] %>%
    st_drop_geometry() %>%
    left_join(dplyr::select(acsTractsNJ.2019.sf, GEOID)) %>%
    st_sf() %>%
  mutate(Select_type = "Select by Centroid")
```


# Exploratory analysis

Visualize price per sq foot
```{r}

ggplot() +
  geom_sf(data = acsTractsCol.2019.sf, fill = "grey40") +
  geom_sf(data = studentData.training, aes(colour = q5(pricePerSF)), 
          show.legend = "point", size = .75) +
  scale_colour_manual(values = palette5,
                   labels=qBr(studentData.training,"pricePerSF"),
                   name="Quintile\nBreaks") +
  labs(title="Price Per Square Foot, Boulder Ccounty Colorado") +
  mapTheme()
```

Visualize price as a function of various continuous variables
```{r}
st_drop_geometry(studentData.training) %>% 
  dplyr::select(price, TotalFinishedSF, age, iprvmntAge) %>%
  filter(price <= 5000000, age < 500) %>%
  gather(Variable, Value, -price) %>% 
   ggplot(aes(Value, price)) +
     geom_point(size = .5) + geom_smooth(method = "lm", se=F, colour = "#FA7800") +
     facet_wrap(~Variable, ncol = 3, scales = "free") +
     labs(title = "Price as a function of continuous variables") +
     plotTheme()
```

Price as a function of categorical variables
```{r, fig.height=15, fig.width=10}
st_drop_geometry(studentData.training) %>% 
  dplyr::select(price, designCodeDscr, ConstCodeDscr, carStorageTypeDscr) %>%
  # mutate(NUM_FLOORS = as.factor(NUM_FLOORS)) %>%
  filter(price <= 5000000) %>%
  gather(Variable, Value, -price) %>% 
   ggplot(aes(Value, price)) +
     geom_bar(position = "dodge", stat = "summary", fun.y = "mean") +
     facet_wrap(~Variable, ncol = 1, scales = "free") +
     labs(title = "Price as a function of\ncategorical variables", y = "Mean_Price") +
     plotTheme() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Correlation matrix
```{r}
numericVars <- 
  st_drop_geometry(studentData.training) %>% 
  select(where(is.numeric)) %>%
  na.omit()
  

ggcorrplot(
  round(cor(numericVars), 1), 
  p.mat = cor_pmat(numericVars),
  colors = c("#25CB10", "white", "#FA7800"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation across numeric variables")
```

# OLS
```{r}
cor.test(studentData.training$TotalFinishedSF, studentData.training$price, method = "pearson")

livingReg <- lm(price ~ TotalFinishedSF, data = studentData.training)

summary(livingReg)
```

Multiple regression
```{r}
reg1 <- lm(price ~ ., data = st_drop_geometry(studentData.training) %>% 
                                 dplyr::select(price, TotalFinishedSF, age, nbrBedRoom, 
                                               nbrFullBaths, designCodeDscr, 
                                               ConstCodeDscr, carStorageTypeDscr,
                                               bsmtSF, AcDscr,  HeatingDscr))
summary(reg1)
```

Testing accuracy using MAE
```{r}
inTrain <- createDataPartition(
              y = paste(studentData.training$TotalFinishedSF, boston.sf$Style, boston.sf$R_AC), 
              p = .60, list = FALSE)
boston.training <- boston.sf[inTrain,] 
boston.test <- boston.sf[-inTrain,]  

reg.training <- lm(SalePrice ~ ., data = st_drop_geometry(boston.training) %>% 
                                    dplyr::select(SalePrice, LivingArea, Style, 
                                               GROSS_AREA, NUM_FLOORS.cat,
                                               R_BDRMS, R_FULL_BTH, R_HALF_BTH, 
                                               R_KITCH, R_AC, R_FPLACE,
                                               crimes.Buffer))
```


```{r}

```

# Appendix
